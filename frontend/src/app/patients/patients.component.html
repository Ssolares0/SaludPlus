<main class="patient-dashboard">
    <div class="dashboard-container">
        <!-- Logo Header -->
        <header class="dashboard-header">
            <div class="header-content">
                <div class="logo-container">
                    <img class="logo" src="assets/images/login/logo.png" alt="Logo de SaludPlus" />
                    <div class="brand-name">
                        <h1 class="brand-title">Centro Médico</h1>
                        <h2 class="brand-subtitle">SaludPlus</h2>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="primary-button" (click)="loadActiveAppointments()">
                        <i class="fas fa-calendar-check"></i>
                        Ver mis citas activas
                    </button>
                </div>
                <!-- Botón de logout -->
                <div class="logout-container">
                    <button class="logout-button" (click)="logout()">
                        <span class="logout-icon">↩</span>
                        <span>Cerrar sesión</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Modal para mostrar citas activas -->
        <div class="modal-overlay" *ngIf="showActiveAppointments" (click)="showActiveAppointments = false">
            <div class="modal-content" (click)="$event.stopPropagation()">
                <h3 class="modal-title">Mis Citas Activas</h3>

                <div *ngIf="loading" class="loading-container">
                    <div class="spinner"></div>
                    <p>Cargando citas...</p>
                </div>

                <div class="appointments-list" *ngIf="!loading && activeAppointments.length > 0">
                    <div class="appointment-card" *ngFor="let appointment of activeAppointments">
                        <div class="appointment-header">
                            <h4>Dr. {{ appointment.doctor.nombre }} {{ appointment.doctor.apellido }}</h4>
                            <span class="appointment-status">{{ appointment.estado }}</span>
                        </div>
                        <div class="appointment-details">
                            <p><strong>Fecha:</strong> {{ appointment.fecha | date:'dd/MM/yyyy HH:mm' }}</p>
                            <p><strong>Motivo:</strong> {{ appointment.motivo }}</p>
                        </div>
                    </div>
                </div>

                <div *ngIf="!loading && activeAppointments.length === 0" class="no-appointments">
                    No tienes citas activas en este momento
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <section class="dashboard-content">
            <div class="content-wrapper">
                <h3 class="section-title">Buscar Médico por Especialidad</h3>
                <p class="section-description">Seleccione la especialidad que necesita consultar</p>

                <!-- Search Form -->
                <form class="search-form">
                    <div class="form-group">
                        <div class="input-container">
                            <select [(ngModel)]="selectedEspecialidad" name="specialty" id="specialty"
                                class="form-input" [class.active-filter]="selectedEspecialidad !== ''"
                                (change)="filterByEspecialidad(selectedEspecialidad)">
                                <option value="">Todas las especialidades</option>
                                <option *ngFor="let especialidad of getUniqueSpecialties()">
                                    {{especialidad}}
                                </option>
                            </select>
                        </div>
                    </div>
                </form>

                <!-- Loading State -->
                <div *ngIf="loading" class="loading-container">
                    <div class="spinner"></div>
                    <span>Cargando información...</span>
                </div>

                <!-- Error Message -->
                <div *ngIf="error" class="error-container">
                    <div class="error-message">{{ error }}</div>
                </div>

                <!-- Doctors Grid -->
                <div class="doctors-grid" *ngIf="!loading && !error">
                    <div *ngFor="let doctor of filteredDoctors" class="doctor-card">
                        <div class="doctor-photo">
                            <img [src]="doctor.foto | safeImage" alt="Dr. {{doctor.nombre}} {{doctor.apellido}}">
                        </div>
                        <div class="card-content">
                            <h3 class="card-title">Dr. {{ doctor.nombre }} {{ doctor.apellido }}</h3>

                            <!-- Especialidades -->
                            <div class="info-group" *ngIf="doctor.especialidad && doctor.especialidad.length > 0">
                                <h4 class="info-label">Especialidades:</h4>
                                <ul class="info-list">
                                    <li *ngFor="let esp of doctor.especialidad">{{ esp }}</li>
                                </ul>
                            </div>

                            <!-- Email (opcional) -->
                            <div class="info-group">
                                <h4 class="info-label">Contacto:</h4>
                                <p class="doctor-email">{{ doctor.email }}</p>
                            </div>

                            <div class="button-group">
                                <button class="secondary-button" (click)="viewSchedule(doctor)">
                                    Ver horarios
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mensaje cuando no hay resultados -->
                <div *ngIf="!loading && !error && filteredDoctors.length === 0" class="no-results">
                    No se encontraron doctores con la especialidad seleccionada
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="dashboard-footer">
            <p class="copyright">© 2025 SaludPlus. Todos los derechos reservados.</p>
            <p class="legal-links">
                <a href="#">Términos y Condiciones</a> •
                <a href="#">Política de Privacidad</a>
            </p>
        </footer>
    </div>

    <!-- Schedule Modal -->
    <div class="modal-overlay" *ngIf="showSchedule" (click)="closeScheduleView()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title">Horarios Disponibles</h3>
            </div>

            <!-- Doctor Info -->
            <div class="doctor-info" *ngIf="selectedDoctor">
                <h4 class="doctor-name">Dr. {{ selectedDoctor.nombre }} {{ selectedDoctor.apellido }}</h4>
            </div>

            <!-- Error Message -->
            <div *ngIf="error" class="error-message">
                {{ error }}
            </div>

            <!-- Doctor Schedule Info -->
            <div class="schedule-info" *ngIf="doctorSchedule">
                <p class="schedule-day">{{ doctorSchedule.day }}</p>
                <p class="schedule-hours">
                    Horario de atención: {{ doctorSchedule.start_time }} - {{ doctorSchedule.end_time }}
                </p>
            </div>

            <!-- Date Selection -->
            <div class="form-group">
                <label class="form-label">Seleccione una fecha:</label>
                <input type="date" [(ngModel)]="selectedDate" name="scheduleDate" class="form-input"
                    (change)="generateAvailableHours()">
            </div>

            <!-- Loading indicator -->
            <div *ngIf="loading" class="loading-container">
                <div class="spinner"></div>
                <p>Cargando horarios...</p>
            </div>

            <!-- Available hours -->
            <div class="time-slots-grid" *ngIf="!loading && availableHours && availableHours.length > 0">
                <div *ngFor="let slot of availableHours" [class.available]="slot.isAvailable"
                    [class.selected]="appointmentTime === slot.time" class="time-slot"
                    (click)="slot.isAvailable && selectTimeSlot(slot)">
                    <span class="time">{{ slot.time }}</span>
                    <span class="status">
                        {{ slot.isAvailable ? 'Disponible' : 'No disponible' }}
                    </span>
                </div>
            </div>

            <!-- No hours message -->
            <div *ngIf="!loading && (!availableHours || availableHours.length === 0)" class="no-hours-message">
                No hay horarios disponibles para esta fecha
            </div>

            <!-- Modal Actions -->
            <div class="button-group">
                <button type="button" class="primary-button" *ngIf="appointmentTime"
                    (click)="showAppointmentForm = true">
                    Agendar cita
                </button>
                <button type="button" class="secondary-button" (click)="closeScheduleView()">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Appointment Form Modal -->
    <div class="modal-overlay" *ngIf="showAppointmentForm" (click)="resetAppointmentForm()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title">Agendar Nueva Cita</h3>
                <button type="button" class="close-button" (click)="resetAppointmentForm()">×</button>
            </div>

            <!-- Mostrar indicador de carga si está procesando -->
            <div *ngIf="loading" class="loading-container">
                <div class="spinner"></div>
                <p>Procesando solicitud...</p>
            </div>

            <!-- Mostrar mensaje de éxito -->
            <div *ngIf="successMessage" class="success-message">
                <div class="success-icon">✓</div>
                <p>{{ successMessage }}</p>
            </div>

            <!-- Formulario -->
            <form (ngSubmit)="scheduleAppointment()" class="appointment-form" *ngIf="!loading && !successMessage">
                <!-- Doctor Info -->
                <div class="form-group">
                    <label class="form-label">Doctor</label>
                    <div class="input-container">
                        <input type="text"
                            [value]="selectedDoctor ? 'Dr. ' + selectedDoctor.nombre + ' ' + selectedDoctor.apellido : ''"
                            class="form-input" readonly>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Fecha</label>
                    <div class="input-container">
                        <input type="date" [(ngModel)]="appointmentDate" name="date" required class="form-input"
                            readonly>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Hora</label>
                    <div class="input-container">
                        <input type="text" [(ngModel)]="appointmentTime" name="time" required class="form-input"
                            readonly>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Motivo de la consulta</label>
                    <div class="input-container">
                        <textarea [(ngModel)]="appointmentReason" name="reason" required rows="4" class="form-input"
                            placeholder="Describa el motivo de su consulta"></textarea>
                    </div>
                </div>

                <!-- Error Message -->
                <div *ngIf="error" class="error-message">
                    {{ error }}
                </div>

                <!-- Form Actions -->
                <div class="button-group">
                    <button type="submit" class="primary-button">Confirmar cita</button>
                    <button type="button" class="secondary-button" (click)="resetAppointmentForm()">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
</main>