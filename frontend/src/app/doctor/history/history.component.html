<div class="history-container">
    <div class="page-header">
        <div class="header-title">
            <h1>Historial de Citas</h1>
            <p>Registro de todas las citas atendidas y canceladas</p>
        </div>
        <div class="header-actions">
            <div class="search-box">
                <i-lucide [name]="Search" class="search-icon"></i-lucide>
                <input type="text" placeholder="Buscar por nombre de paciente o motivo..." class="search-input"
                    [formControl]="searchControl">
            </div>
        </div>
    </div>

    <form [formGroup]="filterForm" class="filter-form">
        <div class="filter-group">
            <label for="status" class="filter-label">Estado</label>
            <select id="status" formControlName="status" class="filter-select">
                <option value="all">Todos los estados</option>
                <option value="completed">Atendidos</option>
                <option value="canceled">Cancelados</option>
                <option value="scheduled">Programados</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="startDate" class="filter-label">Desde</label>
            <input type="date" id="startDate" formControlName="startDate" class="filter-date">
        </div>
        <div class="filter-group">
            <label for="endDate" class="filter-label">Hasta</label>
            <input type="date" id="endDate" formControlName="endDate" class="filter-date">
        </div>
    </form>

    <div class="history-stats">
        <div class="stat-card">
            <div class="stat-icon completed">
                <i-lucide [name]="CheckCircle2"></i-lucide>
            </div>
            <div class="stat-info">
                <span class="stat-value">{{getCompletedCount()}}</span>
                <span class="stat-label">Atendidos</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon canceled">
                <i-lucide [name]="XCircle"></i-lucide>
            </div>
            <div class="stat-info">
                <span class="stat-value">{{getCanceledCount()}}</span>
                <span class="stat-label">Cancelados</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon scheduled">
                <i-lucide [name]="UserX"></i-lucide>
            </div>
            <div class="stat-info">
                <span class="stat-value">{{getScheduledCount()}}</span>
                <span class="stat-label">Programados</span>
            </div>
        </div>
    </div>

    @if (isLoading) {
    <div class="loading-container">
        <div class="loading-spinner"></div>
        <p>Cargando historial de citas...</p>
    </div>
    }

    @if (error) {
    <div class="error-state">
        <i-lucide [name]="AlertCircle" class="error-icon"></i-lucide>
        <p>{{ error }}</p>
    </div>
    }

    @if (!isLoading && !error && filteredAppointments.length === 0) {
    <div class="no-results">
        <div class="empty-state">
            <i-lucide [name]="ClipboardList" class="empty-icon"></i-lucide>
            <h3>No se encontraron citas</h3>
            <p>No hay citas que coincidan con tu búsqueda</p>
        </div>
    </div>
    }

    @if (!isLoading && !error && filteredAppointments.length > 0) {
    <div class="history-grid">
        @for (appointment of paginatedAppointments; track trackByAppointmentId(0, appointment)) {
        <div class="history-card">
            <div class="appointment-header">
                <div class="patient-info">
                    @if (appointment.patient.person.photo) {
                    <div class="patient-photo">
                        <img [src]="appointment.patient.person.photo | safeImage" alt="Foto de paciente">
                    </div>
                    } @else {
                    <div class="patient-avatar">
                        {{appointment.patient.person.first_name[0]}}
                    </div>
                    }
                    <div class="patient-details">
                        <h3>{{appointment.patient.person.first_name}} {{appointment.patient.person.last_name}}</h3>
                        <p class="patient-metadata">
                            {{ getPatientAge(appointment.patient.person.birth_date) }} años •
                            {{ getGenderText(appointment.patient.person.gender) }}
                        </p>
                        <span class="status-badge" [ngClass]="getStatusClass(appointment.status)">
                            {{getStatusText(appointment.status)}}
                        </span>
                    </div>
                </div>
                <div class="appointment-date">
                    <div class="date-item">
                        <i-lucide [name]="Calendar" class="date-icon"></i-lucide>
                        <span>{{formatDate(appointment.appointment_date)}}</span>
                    </div>
                    <div class="date-item">
                        <i-lucide [name]="Clock" class="date-icon"></i-lucide>
                        <span>{{formatTime(appointment.appointment_date)}}</span>
                    </div>
                </div>
            </div>

            <div class="appointment-details">
                <div class="detail-item">
                    <i-lucide [name]="FileText" class="detail-icon"></i-lucide>
                    <div class="detail-content">
                        <span class="detail-label">Motivo de la consulta:</span>
                        <span class="detail-value">{{appointment.reason}}</span>
                    </div>
                </div>

                @if (appointment.treatment) {
                <div class="detail-item">
                    <i-lucide [name]="CheckCircle2" class="detail-icon"></i-lucide>
                    <div class="detail-content">
                        <span class="detail-label">Tratamiento:</span>
                        <span class="detail-value">{{appointment.treatment}}</span>
                    </div>
                </div>
                }

                @if (appointment.cancellation_reason) {
                <div class="detail-item">
                    <i-lucide [name]="XCircle" class="detail-icon"></i-lucide>
                    <div class="detail-content">
                        <span class="detail-label">Motivo de cancelación:</span>
                        <span class="detail-value">{{appointment.cancellation_reason}}</span>
                    </div>
                </div>
                }
            </div>

            <div class="patient-contact">
                <div class="contact-item">
                    <span class="contact-label">Teléfono:</span>
                    <span class="contact-value">{{ appointment.patient.person.phone }}</span>
                </div>
                <div class="contact-item">
                    <span class="contact-label">DPI:</span>
                    <span class="contact-value">{{ appointment.patient.person.national_id }}</span>
                </div>
                <div class="contact-item">
                    <span class="contact-label">Email:</span>
                    <span class="contact-value">{{ appointment.patient.person.email }}</span>
                </div>
            </div>
        </div>
        }
    </div>
    }

    @if (!isLoading && !error && totalPages > 1) {
    <div class="pagination-controls">
        <button class="pagination-btn" [disabled]="currentPage === 1" (click)="changePage(currentPage - 1)">
            Anterior
        </button>

        <div class="pagination-numbers">
            @for (pageNum of getVisiblePages(); track pageNum) {
            <button class="pagination-num-btn" [class.pagination-active]="pageNum === currentPage"
                (click)="changePage(pageNum)">
                {{pageNum}}
            </button>
            }
        </div>

        <button class="pagination-btn" [disabled]="currentPage === totalPages" (click)="changePage(currentPage + 1)">
            Siguiente
        </button>
    </div>
    }
</div>